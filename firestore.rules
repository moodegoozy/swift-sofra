rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============ Helper Functions ============
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'developer'];
    }

    function isStaff() {
      return isAuthenticated() && getUserRole() in ['admin', 'developer', 'supervisor', 'support', 'accountant', 'social_media'];
    }

    // ============ Users ============
    match /users/{userId} {
      // Users can read their own profile; admins can read any
      allow read: if isOwner(userId) || isStaff();
      // Users can create their own profile on registration
      allow create: if isOwner(userId);
      // Users can update their own profile; admins can update any
      allow update: if isOwner(userId) || isAdmin();
      // Only admins can delete users
      allow delete: if isAdmin();

      // User subcollections (notifications, etc.)
      match /{subcollection}/{docId} {
        allow read, write: if isOwner(userId) || isStaff();
      }
    }

    // ============ Restaurants ============
    match /restaurants/{restaurantId} {
      // Anyone authenticated can read restaurants
      allow read: if isAuthenticated();
      // Restaurant owner can create/update their own restaurant (doc id = ownerId)
      allow create: if isOwner(restaurantId);
      allow update: if isOwner(restaurantId) || isAdmin();
      allow delete: if isAdmin();

      // Restaurant subcollections (menu items, etc.)
      match /{subcollection}/{docId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(restaurantId) || isAdmin();
      }
    }

    // ============ Menu Items ============
    match /menuItems/{itemId} {
      allow read: if isAuthenticated();
      // Owner of the restaurant can manage menu items
      allow create, update: if isAuthenticated() &&
        (resource == null || get(/databases/$(database)/documents/restaurants/$(request.resource.data.restaurantId)).data.ownerId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() &&
        (get(/databases/$(database)/documents/restaurants/$(resource.data.restaurantId)).data.ownerId == request.auth.uid || isAdmin());
    }

    // ============ Orders ============
    match /orders/{orderId} {
      // Customer who placed the order, restaurant owner, assigned courier, or staff can read
      allow read: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.restaurantId == request.auth.uid ||
        resource.data.courierId == request.auth.uid ||
        isStaff()
      );
      // Authenticated users can create orders
      allow create: if isAuthenticated();
      // Participants and staff can update orders
      allow update: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.restaurantId == request.auth.uid ||
        resource.data.courierId == request.auth.uid ||
        isStaff()
      );
      // Only admins can delete orders
      allow delete: if isAdmin();
    }

    // ============ Notifications ============
    match /notifications/{notifId} {
      // Users can read their own notifications; staff can read all
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isStaff()
      );
      // System/staff can create notifications for any user
      allow create: if isAuthenticated();
      // User can update their own notifications (mark as read)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Admin can delete
      allow delete: if isAdmin();
    }

    // ============ Support Tickets ============
    match /supportTickets/{ticketId} {
      // User can read their own tickets; staff can read all
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isStaff()
      );
      // Any authenticated user can create a support ticket
      allow create: if isAuthenticated();
      // Staff can update tickets
      allow update: if isStaff();
      allow delete: if isAdmin();
    }

    // ============ Courier Requests ============
    match /courierRequests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isStaff()
      );
      allow create: if isAuthenticated();
      allow update: if isStaff();
      allow delete: if isAdmin();
    }

    // ============ Stories ============
    match /stories/{storyId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() && (
        resource == null ||
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    // ============ Reviews / Ratings ============
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }

    // ============ Wallets ============
    match /wallets/{walletId} {
      allow read: if isOwner(walletId) || isStaff();
      allow create: if isOwner(walletId) || isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ============ Settings / Config ============
    match /settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ============ Chat Messages ============
    match /chats/{chatId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();

      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
    }

    // ============ Packages ============
    match /packages/{packageId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ============ Reports ============
    match /reports/{reportId} {
      allow read: if isStaff();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ============ Promotions ============
    match /promotions/{promoId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ============ Cities ============
    match /cities/{cityId} {
      allow read: if true;  // Public read for city list
      allow write: if isAdmin();
    }
  }
}
