const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-KZtUeJ_q.js","assets/vendor-react-COcEUdcw.js","assets/vendor-firebase-CIIT5h2g.js","assets/vendor-icons-BoNO0IsB.js","assets/vendor-paypal-DO3GBzXH.js","assets/index-BZrQdqyy.css"])))=>i.map(i=>d[i]);
import{d as f,_ as g}from"./index-KZtUeJ_q.js";import{p,t as m,u as w,H as y,K as R,I as d}from"./vendor-firebase-CIIT5h2g.js";import"./vendor-react-COcEUdcw.js";import"./vendor-icons-BoNO0IsB.js";import"./vendor-paypal-DO3GBzXH.js";async function B(e){var u,r,s;const n={success:!1,refundedAmount:0,details:{restaurantRefunded:0,adminRefunded:0,appRefunded:0,customerRefunded:0}};try{const{customerId:o,restaurantId:_,restaurantEarnings:I=0,adminCommission:h=0,appEarnings:$=0,referredBy:A,paymentMethod:D,total:c}=e;if(I>0&&_)try{const t=p(f,"wallets",_),i=await m(t);if(i.exists()){const l=((u=i.data())==null?void 0:u.balance)||0,a=Math.min(I,l);a>0&&(await w(t,{balance:d(-a),totalRefunded:d(a),updatedAt:R(),transactions:y({id:`refund_${e.id}_${Date.now()}`,type:"refund",amount:-a,description:`استرداد طلب #${e.id.slice(-6)} (إلغاء)`,orderId:e.id,createdAt:new Date})}),n.details.restaurantRefunded=a)}}catch(t){console.warn("⚠️ فشل استرداد المبلغ من محفظة المطعم:",t)}if(h>0&&A)try{const t=p(f,"wallets",A),i=await m(t);if(i.exists()){const l=((r=i.data())==null?void 0:r.balance)||0,a=Math.min(h,l);a>0&&(await w(t,{balance:d(-a),totalRefunded:d(a),updatedAt:R(),transactions:y({id:`refund_${e.id}_${Date.now()}`,type:"refund",amount:-a,description:`استرداد عمولة طلب #${e.id.slice(-6)} (إلغاء)`,orderId:e.id,createdAt:new Date})}),n.details.adminRefunded=a)}}catch(t){console.warn("⚠️ فشل استرداد عمولة المشرف:",t)}if($>0)try{const t=p(f,"wallets","app_earnings"),i=await m(t);if(i.exists()){const l=((s=i.data())==null?void 0:s.balance)||0,a=Math.min($,l);a>0&&(await w(t,{balance:d(-a),totalRefunded:d(a),updatedAt:R(),transactions:y({id:`refund_${e.id}_${Date.now()}`,type:"refund",amount:-a,description:`استرداد رسوم طلب #${e.id.slice(-6)} (إلغاء)`,orderId:e.id,createdAt:new Date})}),n.details.appRefunded=a)}}catch(t){console.warn("⚠️ فشل استرداد رسوم المنصة:",t)}if(D==="wallet"&&c>0&&o)try{const t=p(f,"wallets",o);(await m(t)).exists()&&(await w(t,{balance:d(c),totalRefunded:d(c),updatedAt:R(),transactions:y({id:`refund_${e.id}_${Date.now()}`,type:"credit",amount:c,description:`استرداد طلب #${e.id.slice(-6)} (إلغاء)`,orderId:e.id,createdAt:new Date})}),n.details.customerRefunded=c)}catch(t){console.warn("⚠️ فشل إرجاع المبلغ للعميل:",t)}n.refundedAmount=n.details.restaurantRefunded+n.details.adminRefunded+n.details.appRefunded,n.success=!0,console.log("✅ تم استرداد المبالغ بنجاح:",n)}catch(o){console.error("❌ فشل عملية الاسترداد:",o),n.error=String(o)}return n}async function E(e,n,u){try{const{sendSmartNotification:r}=await g(async()=>{const{sendSmartNotification:s}=await import("./index-KZtUeJ_q.js").then(o=>o.n);return{sendSmartNotification:s}},__vite__mapDeps([0,1,2,3,4,5]));if(e.customerId){let s="تم إلغاء طلبك";n.details.customerRefunded>0&&(s+=` وتم استرداد ${n.details.customerRefunded.toFixed(2)} ر.س لمحفظتك`),await r({type:"order_delivered",recipientId:e.customerId,recipientType:"customer",title:"تم إلغاء الطلب ❌",message:s,orderId:e.id,actionType:"order",actionUrl:"/orders",priority:"high"})}e.restaurantId&&u!=="owner"&&await r({type:"order_delivered",recipientId:e.restaurantId,recipientType:"owner",title:"تم إلغاء طلب ❌",message:`تم إلغاء الطلب #${e.id.slice(-6)} واسترداد ${n.details.restaurantRefunded.toFixed(2)} ر.س`,orderId:e.id,actionType:"order",actionUrl:"/owner/orders",priority:"high"})}catch(r){console.warn("⚠️ فشل إرسال إشعارات الاسترداد:",r)}}export{E as notifyRefundParties,B as processOrderRefund};
